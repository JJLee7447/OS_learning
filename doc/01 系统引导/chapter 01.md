# 部署工作环境

编译器 gcc

汇编器 nasm

虚拟机 bochs

### 测试环境

编写 boot.asm 将其编译为 bin 文件

```asm

; 主引导扇区

[org 0x7c00]

; 设置显示模式为文本模式，清除屏幕
mov ax,3
int 0x10 

; 初始化段寄存器

mov ax, 0
mov ds, ax
mov es, ax
mov ss, ax
mov sp ,0x7c00 ;初始化栈段到0x7c00

; 0xb8000是显存的起始地址
mov ax, 0xb800
mov ds, ax

mov byte [0], 'A'
; 无限循环 起到阻塞的作用
jmp $
; 填充剩余空间, 使得主引导扇区大小为512字节
time 510 - ($ -- $$) db 0 
; 主引导扇区的魔术，结束标志jJ
db 0x55, 0xaa

```

#### 编译
    
    nasm -f bin boot.asm -o boot.bin

在这个命令中，-f bin 表示要将汇编代码输出为二进制格式，并且 boot.asm 是输入文件，-o boot.bin 指定输出文件名为 boot.bin。这应该能够成功编译你的汇编代码为二进制文件。

#### 创建硬盘镜像

##### 创建硬盘镜像
```bash
bximage -q -hd=16 -func=create -sectsize=512 -imgmode=flat master.img

# -q 表示静默模式
# -hd=16 表示创建一个容量为 16 MB 的硬盘映像文件
# -func=create 表示创建一个新的虚拟硬盘映像文件
# -sectsize=512 表示扇区大小为 512 字节
# -imgmode=flat 表示使用 "flat" 模式
# master.img 表示硬盘映像文件的名称

# 使用 | 进行 repalace 确认 
yes | bximage -q -hd=16 -func=create -sectsize=512 -imgmode=flat master.img 

```

```bash
╰─$ yes | bximage -q -hd=16 -func=create -sectsize=512 -imgmode=flat master.img 
========================================================================
                                bximage
  Disk Image Creation / Conversion / Resize and Commit Tool for Bochs
         $Id: bximage.cc 14091 2021-01-30 17:37:42Z sshwarts $
========================================================================

The disk image 'master.img' already exists.  Are you sure you want to replace it?
Please type yes or no. [no] 
Creating hard disk image 'master.img' with CHS=32/16/63 (sector size = 512)

The following line should appear in your bochsrc:
  ata0-master: type=disk, path="master.img", mode=flat # 主引导扇区的硬盘映像文件
```
##### 将 boot.bin 写入硬盘镜像

```bash

dd if=boot.bin of=master.img bs=512 count=1 conv=notrunc

# if 表示输入文件
# of 表示输出文件
# bs 表示每次读取的字节数
# count 表示读取的次数
# conv=notrunc 表示不截断输出文件
```

## 配置 bochs

ata0-master: type=disk, path="master.img", mode=flat

```bash
# configuration file generated by Bochs
plugin_ctrl: unmapped=true, biosdev=true, speaker=true, extfpuirq=true, parallel=true, serial=true, iodebug=true, pcidev=false, usb_uhci=false
config_interface: textconfig
display_library: x,options="gui_debug"
memory: host=32, guest=32
romimage: file="/usr/share/bochs/BIOS-bochs-latest", address=0x00000000, options=none
vgaromimage: file="/usr/share/bochs/VGABIOS-lgpl-latest"
boot: disk
floppy_bootsig_check: disabled=0
floppya: type=1_44
# no floppyb
ata0: enabled=true, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
ata0-master: type=disk, path="master.img", mode=flat
ata0-slave: type=none
ata1: enabled=true, ioaddr1=0x170, ioaddr2=0x370, irq=15
ata1-master: type=none
ata1-slave: type=none
ata2: enabled=false
ata3: enabled=false
optromimage1: file=none
optromimage2: file=none
optromimage3: file=none
optromimage4: file=none
optramimage1: file=none
optramimage2: file=none
optramimage3: file=none
optramimage4: file=none
pci: enabled=1, chipset=i440fx, slot1=none, slot2=none, slot3=none, slot4=none, slot5=none
vga: extension=vbe, update_freq=5, realtime=1, ddc=builtin
cpu: count=1:1:1, ips=4000000, quantum=16, model=bx_generic, reset_on_triple_fault=1, cpuid_limit_winnt=0, ignore_bad_msrs=1, mwait_is_nop=0
cpuid: level=6, stepping=3, model=3, family=6, vendor_string="AuthenticAMD", brand_string="AMD Athlon(tm) processor"
cpuid: mmx=true, apic=xapic, simd=sse2, sse4a=false, misaligned_sse=false, sep=true
cpuid: movbe=false, adx=false, aes=false, sha=false, xsave=false, xsaveopt=false, avx_f16c=false
cpuid: avx_fma=false, bmi=0, xop=false, fma4=false, tbm=false, x86_64=true, 1g_pages=false
cpuid: pcid=false, fsgsbase=false, smep=false, smap=false, mwait=true
print_timestamps: enabled=0
debugger_log: -
magic_break: enabled=0
port_e9_hack: enabled=0
private_colormap: enabled=0
clock: sync=none, time0=local, rtc_sync=0
# no cmosimage
log: -
logprefix: %t%e%d
debug: action=ignore
info: action=report
error: action=report
panic: action=ask
keyboard: type=mf, serial_delay=250, paste_delay=100000, user_shortcut=none
mouse: type=ps2, enabled=false, toggle=ctrl+mbutton
speaker: enabled=true, mode=system
parport1: enabled=true, file=none
parport2: enabled=false
com1: enabled=true, mode=null
com2: enabled=false
com3: enabled=false
com4: enabled=false


```